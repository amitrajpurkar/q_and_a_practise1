{% extends "base.html" %}

{% block title %}Q&A Practice - {{ session.topic }} {{ session.difficulty }} Quiz{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Quiz Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ session.topic }} - {{ session.difficulty }}</h1>
                <p class="text-gray-600">Session ID: {{ session.session_id }}</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-primary-600" id="question-counter">1/10</div>
                    <div class="text-sm text-gray-500">Questions</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-success-600" id="score-display">0</div>
                    <div class="text-sm text-gray-500">Score</div>
                </div>
                <button onclick="endSession()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    End Session
                </button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
            <div id="progress-bar" class="progress-bar bg-primary-600 h-3 rounded-full" style="width: 10%"></div>
        </div>
        
        <!-- Timer -->
        <div class="flex items-center justify-center text-gray-600">
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="timer">00:00</span>
        </div>
    </div>

    <!-- Question Container -->
    <div id="question-container" class="bg-white rounded-xl shadow-lg p-8 question-card">
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Loading next question...</p>
        </div>
        
        <!-- Question Content ( loaded via HTMX ) -->
        <div id="question-content" class="hidden">
            <!-- Question will be loaded here -->
        </div>
        
        <!-- Feedback Section -->
        <div id="feedback-section" class="hidden mt-6 p-4 rounded-lg">
            <!-- Feedback will be shown here -->
        </div>
        
        <!-- Navigation Buttons -->
        <div id="navigation-buttons" class="hidden flex justify-between items-center mt-8">
            <button id="skip-button" onclick="skipQuestion()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                Skip Question
            </button>
            <div class="flex space-x-3">
                <button id="next-button" onclick="nextQuestion()" class="hidden px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    Next Question â†’
                </button>
                <button id="finish-button" onclick="finishQuiz()" class="hidden px-6 py-2 bg-success-600 text-white rounded-lg hover:bg-success-700 transition-colors">
                    Finish Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- Session Stats -->
    <div class="mt-6 grid grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-xl font-bold text-primary-600" id="correct-count">0</div>
            <div class="text-sm text-gray-600">Correct</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-xl font-bold text-error-600" id="incorrect-count">0</div>
            <div class="text-sm text-gray-600">Incorrect</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-xl font-bold text-warning-600" id="skipped-count">0</div>
            <div class="text-sm text-gray-600">Skipped</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-xl font-bold text-gray-600" id="accuracy-rate">0%</div>
            <div class="text-sm text-gray-600">Accuracy</div>
        </div>
    </div>
</div>

<!-- End Session Modal -->
<div id="end-session-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-900 mb-4">End Session?</h3>
        <p class="text-gray-600 mb-6">Are you sure you want to end this practice session? Your progress will be saved.</p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeEndSessionModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                Cancel
            </button>
            <button onclick="confirmEndSession()" class="px-4 py-2 bg-error-600 text-white rounded-lg hover:bg-error-700 transition-colors">
                End Session
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* 
 * NOTE: This file contains Jinja2 template syntax that JavaScript linters 
 * cannot parse. Lint errors are expected and don't affect functionality. 
 * The code works correctly when rendered by the Flask/Jinja2 engine.
 * 
 * Template variables like {{ session.session_id }} are processed server-side 
 * before the JavaScript is executed client-side.
 */

// Quiz state management
let quizState = {
    sessionId: '{{ session.session_id }}',
    topic: '{{ session.topic }}',
    difficulty: '{{ session.difficulty }}',
    currentQuestion: 1,
    totalQuestions: 10,
    correctAnswers: 0,
    incorrectAnswers: 0,
    skippedQuestions: 0,
    startTime: Date.now(),
    currentQuestionId: null,
    answered: false
};

// Timer functionality
let timerInterval;
function startTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - quizState.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
}

// Load first question
document.addEventListener('DOMContentLoaded', function() {
    loadQuestion();
    startTimer();
    updateStats();
});

function loadQuestion() {
    // Show loading state
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('question-content').classList.add('hidden');
    document.getElementById('navigation-buttons').classList.add('hidden');
    document.getElementById('feedback-section').classList.add('hidden');
    
    // Reset answered state
    quizState.answered = false;
    
    // Load question via HTMX
    htmx.ajax('GET', `/api/v1/questions/random?session_id=${quizState.sessionId}`, {
        target: '#question-content',
        swap: 'innerHTML'
    }).then(() => {
        // Hide loading state and show question
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('question-content').classList.remove('hidden');
        document.getElementById('navigation-buttons').classList.remove('hidden');
        
        // Update question counter
        document.getElementById('question-counter').textContent = 
            `${quizState.currentQuestion}/${quizState.totalQuestions}`;
        
        // Update progress bar
        const progress = (quizState.currentQuestion / quizState.totalQuestions) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        
        // Add event listeners to option buttons
        const optionButtons = document.querySelectorAll('.option-button');
        optionButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (!quizState.answered) {
                    selectAnswer(this);
                }
            });
        });
    });
}

function selectAnswer(button) {
    if (quizState.answered) return;
    
    // Disable all option buttons
    const optionButtons = document.querySelectorAll('.option-button');
    optionButtons.forEach(btn => btn.disabled = true);
    
    // Get selected answer
    const selectedAnswer = button.dataset.answer;
    const questionId = button.dataset.questionId;
    
    // Submit answer
    submitAnswer(questionId, selectedAnswer, button);
}

function submitAnswer(questionId, answer, buttonElement) {
    const formData = new FormData();
    formData.append('question_id', questionId);
    formData.append('answer', answer);
    
    htmx.ajax('POST', `/api/v1/sessions/${quizState.sessionId}/answer`, {
        target: '#feedback-section',
        swap: 'innerHTML',
        values: formData
    }).then(() => {
        // Show feedback
        document.getElementById('feedback-section').classList.remove('hidden');
        
        // Update stats based on response
        const feedbackSection = document.getElementById('feedback-section');
        const isCorrect = feedbackSection.classList.contains('correct-answer');
        
        if (isCorrect) {
            quizState.correctAnswers++;
            buttonElement.classList.add('correct-answer');
        } else {
            quizState.incorrectAnswers++;
            buttonElement.classList.add('incorrect-answer');
            // Highlight correct answer
            const correctButton = document.querySelector(`[data-answer="${feedbackSection.dataset.correctAnswer}"]`);
            if (correctButton) {
                correctButton.classList.add('correct-answer');
            }
        }
        
        quizState.answered = true;
        updateStats();
        showNavigationButtons();
    });
}

function showNavigationButtons() {
    const nextButton = document.getElementById('next-button');
    const finishButton = document.getElementById('finish-button');
    
    if (quizState.currentQuestion >= quizState.totalQuestions) {
        finishButton.classList.remove('hidden');
        nextButton.classList.add('hidden');
    } else {
        nextButton.classList.remove('hidden');
        finishButton.classList.add('hidden');
    }
}

function nextQuestion() {
    quizState.currentQuestion++;
    loadQuestion();
}

function skipQuestion() {
    quizState.skippedQuestions++;
    quizState.currentQuestion++;
    updateStats();
    
    if (quizState.currentQuestion > quizState.totalQuestions) {
        finishQuiz();
    } else {
        loadQuestion();
    }
}

function updateStats() {
    document.getElementById('correct-count').textContent = quizState.correctAnswers;
    document.getElementById('incorrect-count').textContent = quizState.incorrectAnswers;
    document.getElementById('skipped-count').textContent = quizState.skippedQuestions;
    document.getElementById('score-display').textContent = quizState.correctAnswers;
    
    // Calculate accuracy
    const totalAttempted = quizState.correctAnswers + quizState.incorrectAnswers;
    const accuracy = totalAttempted > 0 ? 
        Math.round((quizState.correctAnswers / totalAttempted) * 100) : 0;
    document.getElementById('accuracy-rate').textContent = `${accuracy}%`;
}

function endSession() {
    document.getElementById('end-session-modal').classList.remove('hidden');
}

function closeEndSessionModal() {
    document.getElementById('end-session-modal').classList.add('hidden');
}

function confirmEndSession() {
    stopTimer();
    window.location.href = `/results/${quizState.sessionId}`;
}

function finishQuiz() {
    stopTimer();
    window.location.href = `/results/${quizState.sessionId}`;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
    if (quizState.answered) return;
    
    const optionButtons = document.querySelectorAll('.option-button');
    const key = event.key.toUpperCase();
    
    if (key >= 'A' && key <= 'D') {
        const index = key.charCodeAt(0) - 'A'.charCodeAt(0);
        if (index < optionButtons.length) {
            selectAnswer(optionButtons[index]);
        }
    } else if (key === 'S') {
        skipQuestion();
    } else if (key === 'ESCAPE') {
        endSession();
    }
});

// Handle visibility change ( pause timer when tab is not visible )
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopTimer();
    } else {
        startTimer();
    }
});

// Handle page unload
window.addEventListener('beforeunload', function(event) {
    if (quizState.currentQuestion > 1 && quizState.currentQuestion <= quizState.totalQuestions) {
        event.preventDefault();
        event.returnValue = 'You have an active quiz session. Are you sure you want to leave?';
        return event.returnValue;
    }
});
</script>
{% endblock %}
